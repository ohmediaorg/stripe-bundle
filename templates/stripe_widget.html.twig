{%- block stripe_widget -%}
  {{ form_widget(form.token) }}
  {{ form_widget(form.last4) }}

  <div id="{{ form.vars.id }}_card" class="stripe-card"></div>
  <div id="{{ form.vars.id }}_error" class="stripe-error"></div>

  <script>
    window.addEventListener('load', function() {
      const stripe = Stripe('{{ publishable_key }}');

      const card = stripe.elements().create('card', {{ options|raw }});

      card.mount('#{{ form.vars.id }}_card');

      const token = document.getElementById('{{ form.token.vars.id }}');
      const last4 = document.getElementById('{{ form.last4.vars.id }}');

      const error = document.getElementById('{{ form.vars.id }}_error');

      const createToken = function() {
        stripe.createToken(card).then(function(result) {
          if (result.error) {
            token.value = '';
            last4.value = '';

            error.textContent = result.error.message;
          }
          else {
            token.value = result.token.id;
            last4.value = result.token.card.last4;

            error.textContent = '';
          }
        });
      };

      card.addEventListener('blur', function(e) {
        if (e.error) {
          error.textContent = e.error.message;
        }
        else {
          error.textContent = '';

          createToken();
        }
      });
    });
  </script>
{%- endblock -%}
